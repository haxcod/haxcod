name: Update Latest Dispatches

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

jobs:
  refresh:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read latest posts
        id: posts
        run: |
          echo "posts<<EOF" >> $GITHUB_OUTPUT
          cat data/latest-posts.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update README section
        run: |
          python <<'PY'
          from pathlib import Path
          import re

          readme_path = Path("README.md")
          posts_path = Path("data/latest-posts.md")

          posts_raw = posts_path.read_text(encoding="utf-8").strip()
          if not posts_raw:
              raise SystemExit("No posts found in data/latest-posts.md")

          section = (
              "<!-- latest-posts:start -->\n"
              "<!-- Autogenerated by workflow: latest-posts.yml -->\n"
              "<!-- Do not edit directly. Update `data/latest-posts.md` instead. -->\n"
              f"{posts_raw}\n"
              "<!-- latest-posts:end -->"
          )

          readme = readme_path.read_text(encoding="utf-8")
          pattern = re.compile(r"<!-- latest-posts:start -->.*?<!-- latest-posts:end -->", re.S)
          if not pattern.search(readme):
              raise SystemExit("Could not find latest-posts section in README.md")

          updated = pattern.sub(section, readme)
          if updated != readme:
              readme_path.write_text(updated, encoding="utf-8")
              print("README updated with latest posts")
          else:
              print("README already up to date")
          PY

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: refresh latest dispatches"
          file_pattern: README.md
